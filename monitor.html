<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³çƒ­æœå®æ—¶ç›‘æ§ - èƒ¡æ­Œã€å¯éš†å…³é”®è¯</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #1a202c;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .interval-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .interval-selector select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .keywords-list {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .keyword-tag {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .result-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateX(5px);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .result-rank {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            flex: 1;
            margin: 0 15px;
        }
        
        .result-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .result-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .result-link:hover {
            text-decoration: underline;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .no-results-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .no-results-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .no-results-hint {
            font-size: 14px;
            color: #9ca3af;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }
        
        .history-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a202c;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.show {
            display: block;
        }
        
        .toast-success {
            border-left: 4px solid #10b981;
        }
        
        .toast-error {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="status-indicator"></span>
                çƒ­æœå®æ—¶ç›‘æ§ - <span id="currentPlatform">å…¨éƒ¨å¹³å°</span>
            </h1>
            <div class="header-info">
                <div class="info-card">
                    <div class="info-label">ç›‘æ§å¹³å°</div>
                    <div class="info-value" id="platformCount">2</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ç›‘æ§å…³é”®è¯</div>
                    <div class="info-value" id="keywordCount">3</div>
                </div>
                <div class="info-card">
                    <div class="info-label">åŒ¹é…ç»“æœ</div>
                    <div class="info-value" id="matchCount">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">æœ€åæ›´æ–°</div>
                    <div class="info-value" style="font-size: 14px;" id="lastUpdate">æœªæ›´æ–°</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ä¸‹æ¬¡æ›´æ–°</div>
                    <div class="info-value" style="font-size: 14px;" id="nextUpdate">--:--</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="fetchData()">
                ğŸ”„ ç«‹å³åˆ·æ–°
            </button>
            <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
                <span id="autoRefreshBtn">â–¶ï¸ å¼€å¯è‡ªåŠ¨åˆ·æ–°</span>
            </button>
            <div class="interval-selector">
                <label>åˆ·æ–°é—´éš”:</label>
                <select id="intervalSelect" onchange="updateInterval()">
                    <option value="30000">30ç§’</option>
                    <option value="60000" selected>1åˆ†é’Ÿ</option>
                    <option value="300000">5åˆ†é’Ÿ</option>
                    <option value="600000">10åˆ†é’Ÿ</option>
                    <option value="1800000">30åˆ†é’Ÿ</option>
                </select>
            </div>
            <div class="interval-selector">
                <label>å¹³å°ç­›é€‰:</label>
                <select id="platformFilter" onchange="filterByPlatform()">
                    <option value="all">å…¨éƒ¨å¹³å°</option>
                    <option value="douyin">æŠ–éŸ³</option>
                    <option value="weibo">å¾®åš</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="openOutputFolder()">
                ğŸ“ æŸ¥çœ‹æ•°æ®æ–‡ä»¶
            </button>
        </div>
        
        <div class="content">
            <div class="keywords-list">
                <div class="keyword-tag">èƒ¡æ­Œ</div>
                <div class="keyword-tag">å¯éš†</div>
                <div class="keyword-tag">kolon / KOLON</div>
            </div>
            
            <div class="results" id="results">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
                </div>
            </div>
            
            <div class="history-section">
                <h3 class="history-title">ğŸ“Š å†å²ç›‘æ§è®°å½•</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>
    
    <script>
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;
        let refreshInterval = 60000; // é»˜è®¤1åˆ†é’Ÿ
        let history = [];
        let allData = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®
        let currentFilter = 'all'; // å½“å‰ç­›é€‰å¹³å°
        
        // ç›‘æ§çš„å…³é”®è¯
        const keywords = ['èƒ¡æ­Œ', 'å¯éš†', 'kolon', 'KOLON'];
        
        // å¹³å°æ˜ å°„
        const platformMap = {
            'douyin': 'æŠ–éŸ³',
            'weibo': 'å¾®åš'
        };
        
        // åˆå§‹åŒ–
        window.onload = function() {
            fetchData();
            loadHistory();
        };
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'toast show toast-' + type;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            isAutoRefreshing = !isAutoRefreshing;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshing) {
                btn.textContent = 'â¸ï¸ åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                startAutoRefresh();
                showToast('å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°');
            } else {
                btn.textContent = 'â–¶ï¸ å¼€å¯è‡ªåŠ¨åˆ·æ–°';
                stopAutoRefresh();
                showToast('å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°', 'error');
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(() => {
                fetchData();
            }, refreshInterval);
            updateNextRefreshTime();
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            document.getElementById('nextUpdate').textContent = '--:--';
        }
        
        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateInterval() {
            const select = document.getElementById('intervalSelect');
            refreshInterval = parseInt(select.value);
            if (isAutoRefreshing) {
                startAutoRefresh();
                showToast(`åˆ·æ–°é—´éš”å·²æ›´æ–°ä¸º ${select.options[select.selectedIndex].text}`);
            }
        }
        
        // æ›´æ–°ä¸‹æ¬¡åˆ·æ–°æ—¶é—´
        function updateNextRefreshTime() {
            if (!isAutoRefreshing) return;
            
            const nextTime = new Date(Date.now() + refreshInterval);
            const timeStr = nextTime.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('nextUpdate').textContent = timeStr;
        }
        
        // è·å–æ•°æ®
        async function fetchData() {
            try {
                // è°ƒç”¨Pythonè„šæœ¬æŠ“å–æœ€æ–°æ•°æ®
                const response = await fetch('http://localhost:8000/api/fetch', {
                    method: 'POST'
                }).catch(() => {
                    // å¦‚æœAPIä¸å¯ç”¨ï¼Œè¯»å–æœ¬åœ°æ–‡ä»¶
                    return readLocalData();
                });
                
                if (!response) {
                    readLocalData();
                    return;
                }
                
                const result = await response.json();
                const platformsData = result.platforms || [];
                
                displayAllPlatformsData(platformsData);
                updateStatsMultiPlatform(platformsData);
                saveToHistoryMultiPlatform(platformsData);
                
                document.getElementById('lastUpdate').textContent = 
                    new Date().toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                if (isAutoRefreshing) {
                    updateNextRefreshTime();
                }
                
                showToast('æ•°æ®æ›´æ–°æˆåŠŸï¼');
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                readLocalData();
            }
        }
        
        // æ›´æ–°å¤šå¹³å°ç»Ÿè®¡ä¿¡æ¯
        function updateStatsMultiPlatform(platformsData) {
            let totalMatches = 0;
            platformsData.forEach(data => {
                const items = data.items || [];
                items.forEach(item => {
                    const title = item.title.toLowerCase();
                    if (keywords.some(keyword => title.includes(keyword.toLowerCase()))) {
                        totalMatches++;
                    }
                });
            });
            document.getElementById('matchCount').textContent = totalMatches;
        }
        
        // ä¿å­˜å¤šå¹³å°å†å²è®°å½•
        function saveToHistoryMultiPlatform(platformsData) {
            let allMatchedItems = [];
            
            platformsData.forEach(data => {
                const items = data.items || [];
                items.forEach(item => {
                    const title = item.title.toLowerCase();
                    if (keywords.some(keyword => title.includes(keyword.toLowerCase()))) {
                        allMatchedItems.push({
                            platform: data.platformName,
                            title: item.title
                        });
                    }
                });
            });
            
            if (allMatchedItems.length > 0) {
                history.unshift({
                    timestamp: new Date().toISOString(),
                    count: allMatchedItems.length,
                    items: allMatchedItems
                });
                
                // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                history = history.slice(0, 20);
                localStorage.setItem('monitorHistory', JSON.stringify(history));
                displayHistory();
            }
        }
        
        // è¯»å–æœ¬åœ°æ•°æ®æ–‡ä»¶
        function readLocalData() {
            // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…éƒ¨ç½²æ—¶éœ€è¦é…ç½®æœ¬åœ°æ–‡ä»¶æœåŠ¡å™¨ï¼‰
            const simulatedData = {
                platform: 'æŠ–éŸ³',
                items: [],
                timestamp: new Date().toISOString()
            };
            
            displayResults(simulatedData);
            updateStats(simulatedData);
            
            document.getElementById('lastUpdate').textContent = 
                new Date().toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        // å¹³å°ç­›é€‰
        function filterByPlatform() {
            const select = document.getElementById('platformFilter');
            currentFilter = select.value;
            
            // æ›´æ–°æ ‡é¢˜
            const platformText = currentFilter === 'all' ? 'å…¨éƒ¨å¹³å°' : platformMap[currentFilter];
            document.getElementById('currentPlatform').textContent = platformText;
            
            // é‡æ–°æ˜¾ç¤ºæ•°æ®
            if (allData.length > 0) {
                displayAllPlatformsData(allData);
            }
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰å¹³å°çš„æ•°æ®
        function displayAllPlatformsData(platformsData) {
            allData = platformsData;
            const resultsDiv = document.getElementById('results');
            let allMatchedItems = [];
            
            // æ”¶é›†æ‰€æœ‰åŒ¹é…çš„é¡¹ç›®
            platformsData.forEach(data => {
                const items = data.items || [];
                items.forEach(item => {
                    const title = item.title.toLowerCase();
                    if (keywords.some(keyword => title.includes(keyword.toLowerCase()))) {
                        // æ ¹æ®ç­›é€‰æ¡ä»¶
                        if (currentFilter === 'all' || data.platform === currentFilter) {
                            allMatchedItems.push({
                                ...item,
                                platformId: data.platform,
                                platformName: data.platformName
                            });
                        }
                    }
                });
            });
            
            // æ›´æ–°åŒ¹é…æ•°é‡
            document.getElementById('matchCount').textContent = allMatchedItems.length;
            
            if (allMatchedItems.length === 0) {
                const platformText = currentFilter === 'all' ? 'æ‰€æœ‰ç›‘æ§å¹³å°' : platformMap[currentFilter];
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”</div>
                        <div class="no-results-text">æš‚æœªå‘ç°ç›¸å…³çƒ­æœ</div>
                        <div class="no-results-hint">
                            å½“å‰${platformText}çš„çƒ­æœæ¦œä¸­æœªåŒ…å«"èƒ¡æ­Œ"ã€"å¯éš†"ã€"kolon"ç›¸å…³å†…å®¹<br>
                            ç³»ç»Ÿå°†æŒç»­ç›‘æ§ï¼Œä¸€æ—¦å‡ºç°ç›¸å…³å†…å®¹å°†ç«‹å³æ˜¾ç¤º
                        </div>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = allMatchedItems.map(item => `
                <div class="result-item">
                    <div class="result-header">
                        <div class="result-rank">#${item.rank}</div>
                        <div class="result-title">
                            <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                                   color: white; padding: 2px 8px; border-radius: 4px; 
                                   font-size: 12px; margin-right: 8px;">
                                ${item.platformName}
                            </span>
                            ${highlightKeywords(item.title)}
                        </div>
                        <div class="result-time">${formatTime(item.timestamp)}</div>
                    </div>
                    <a href="${item.url}" target="_blank" class="result-link">
                        æŸ¥çœ‹è¯¦æƒ… â†’
                    </a>
                </div>
            `).join('');
        }
        
        // æ˜¾ç¤ºç»“æœï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function displayResults(data) {
            displayAllPlatformsData([data]);
        }
        
        // é«˜äº®å…³é”®è¯
        function highlightKeywords(text) {
            let result = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(keyword, 'gi');
                result = result.replace(regex, match => 
                    `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                        ${match}
                    </span>`
                );
            });
            return result;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(data) {
            const items = data.items || [];
            const matchedItems = items.filter(item => {
                const title = item.title.toLowerCase();
                return keywords.some(keyword => 
                    title.includes(keyword.toLowerCase())
                );
            });
            
            document.getElementById('matchCount').textContent = matchedItems.length;
        }
        
        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(data) {
            const items = data.items || [];
            const matchedItems = items.filter(item => {
                const title = item.title.toLowerCase();
                return keywords.some(keyword => 
                    title.includes(keyword.toLowerCase())
                );
            });
            
            if (matchedItems.length > 0) {
                history.unshift({
                    timestamp: new Date().toISOString(),
                    count: matchedItems.length,
                    items: matchedItems
                });
                
                // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                history = history.slice(0, 20);
                localStorage.setItem('monitorHistory', JSON.stringify(history));
                displayHistory();
            }
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const saved = localStorage.getItem('monitorHistory');
            if (saved) {
                history = JSON.parse(saved);
                displayHistory();
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory() {
            const historyDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            historyDiv.innerHTML = history.map(record => `
                <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600;">${formatTime(record.timestamp)}</span>
                        <span style="color: #667eea; font-weight: 600;">å‘ç° ${record.count} æ¡åŒ¹é…</span>
                    </div>
                    <div style="font-size: 14px; color: #6b7280;">
                        ${record.items.map(item => {
                            if (item.platform) {
                                return `â€¢ [${item.platform}] ${item.title}`;
                            }
                            return `â€¢ ${item.title}`;
                        }).join('<br>')}
                    </div>
                </div>
            `).join('');
        }
        
        // æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹
        function openOutputFolder() {
            showToast('è¯·æ‰‹åŠ¨æ‰“å¼€: TrendRadar/output æ–‡ä»¶å¤¹æŸ¥çœ‹å®Œæ•´æ•°æ®');
        }
        
        // å®šæ—¶æ›´æ–°ä¸‹æ¬¡åˆ·æ–°æ—¶é—´æ˜¾ç¤º
        setInterval(() => {
            if (isAutoRefreshing) {
                updateNextRefreshTime();
            }
        }, 1000);
    </script>
</body>
</html>

